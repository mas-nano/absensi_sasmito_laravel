{
  admin off
  persist_config off
  auto_https off

  {$CADDY_GLOBAL_OPTIONS}

  log {
    output stderr
    format json
    level INFO
  }

  frankenphp {
    {$FRANKENPHP_CONFIG}
  }
}

{$CADDY_EXTRA_CONFIG}

:{$PORT:80} {
  root * /app/public
  encode zstd br gzip

  route {
    handle_path /storage* {
      @notRead { 
        not method GET HEAD
      }
      respond @notRead 405

      rewrite * /absen{path}
      header X-Storage-Proxy "1"
      reverse_proxy https://s3.absensi.ptsasmito.com {
        header_up Host s3.absensi.ptsasmito.com
      }
    }

    # Block semua script PHP-ish kecuali /index.php
    @blockedScripts {
      path_regexp blockedScripts (?i)\.(php|phtml|pht|phar|php[0-9])($|/)
      not path /index.php
    }
    respond @blockedScripts 404

    # Block file sensitif / dotfiles
    @forbidden {
      path /.env* /.git/* /.ht* /.user.ini* /php.ini* /composer.* /artisan
    }
    respond @forbidden 404

    php_server
  }
}
